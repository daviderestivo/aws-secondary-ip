* aws-secondary-ip

** sec-ip-cl
:PROPERTIES:
:DATE:     [2025-11-08 Sat 17:11]
:END:

#+begin_src bash
  sudo su -

  hostnamectl set-hostname sec-ip-cl

  dnf -y install emacs pip

  ip addr add 10.0.0.100/24 dev enX0

  mkdir -p /etc/iproute2
  echo "200 secondary" | sudo tee -a /etc/iproute2/rt_tables
  ip rule add to 10.0.0.0/24 table secondary
  ip route add default via 172.31.16.1 src 10.0.0.100 dev enX0 table secondary
#+end_src

*** rc.local config
:PROPERTIES:
:DATE:     [2025-11-08 Sat 17:55]
:END:

#######
sudo tee /etc/rc.local <<'EOF'
#!/bin/bash

ip addr add 10.0.0.100/24 dev enX0

mkdir -p /etc/iproute2
echo "200 secondary" | sudo tee -a /etc/iproute2/rt_tables
ip rule add to 10.0.0.0/24 table secondary
ip route add default via 172.31.16.1 src 10.0.0.100 dev enX0 table secondary
EOF

sudo chmod +x /etc/rc.local
#######

#######
sudo tee /etc/systemd/system/rc-local.service <<'EOF'
[Unit]
Description=/etc/rc.local Compatibility
ConditionPathExists=/etc/rc.local
After=network-online.target
Wants=network-online.target

[Service]
Type=forking
ExecStart=/etc/rc.local start
TimeoutSec=0
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable rc-local
sudo systemctl start rc-local
####

*** Controller
:PROPERTIES:
:DATE:     [2025-11-09 Sun 08:32]
:END:

#+begin_src bash
  pip install boto3
#+end_src


EC2 Policy

In AWS Console:

1. Go to IAM → Policies → Create policy
2. Click "JSON" tab
3. Paste the policy you provided
4. Click "Next: Tags" (skip tags if not needed)
5. Click "Next: Review"
6. Enter policy name: EC2ControllerPolicy
7. Click "Create policy"

Attach to EC2 instance:

1. Go to IAM → Roles → Create role
2. Select "AWS service" → "EC2"
3. Search and select your EC2ControllerPolicy
4. Click "Next" → Enter role name: EC2ControllerRole
5. Click "Create role"
6. Go to EC2 → Select your controller instance
7. Actions → Security → Modify IAM role
8. Select EC2ControllerRole

#+begin_src json
  {
      "Version": "2012-10-17",
      "Statement": [
      	{
      		"Effect": "Allow",
      		"Action": [
      			"ec2:*"
      		],
      		"Resource": "*"
      	}
      ]
  }
#+end_src

#+begin_src bash
  export AWS_DEFAULT_REGION=us-east-1
  python3 ec2_controller.py --instance-id i-03994d9f285e5566d --security-group sg-048094becb5548da7 --keypair 823999505270_sc-ps-training --user-data-file userdata_template.sh --route-destination 10.0.0.10 --debug
#+end_src
